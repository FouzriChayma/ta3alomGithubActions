name: Node.js CI

on: [push]

jobs:
  build-node:
    runs-on: ubuntu-latest
    services:
      mongodb:
        image: mongo:latest
        ports:
          - 27017:27017
        options: >
          --health-cmd "mongo --eval 'db.runCommand({ ping: 1 })'"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
    - uses: actions/checkout@v3

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'

    - name: Cache node_modules
      uses: actions/cache@v3
      id: node-modules-cache
      with:
        path: node_modules
        key: node-modules-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          node-modules-${{ runner.os }}-

    - name: Install dependencies
      if: steps.node-modules-cache.outputs.cache-hit != 'true'
      run: npm ci

    - name: Install Express (Stable Version)
      run: npm install express@4.18.2

    - name: Update mongoose
      run: npm update mongoose --depth 1

    - name: Fix vulnerabilities
      run: npm audit fix

    - name: Check for vulnerabilities
      run: npm audit

    - name: Wait for MongoDB to be fully ready
      run: |
        echo "Waiting for MongoDB..."
        until mongosh --eval 'db.runCommand({ ping: 1 })'; do
          sleep 5
          echo "Retrying..."
        done
        echo "MongoDB is ready!"

    - name: Kill processes using port 3001
      run: |
        echo "Killing processes using port 3001..."
        lsof -ti :3001 | xargs -r kill -9

    - name: Run application
      run: npm start &

    - name: Wait for server to be ready
      run: sleep 10  # Adjust as needed

    - name: Verify server is running
      run: |
        echo "Checking if server is running..."
        if ! curl --fail http://localhost:3001; then
          echo "Server not responding, showing logs:"
          cat server.log
          exit 1
        fi
